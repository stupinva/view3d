View3D - просмотр моделей из Quake при помощи OpenGL
====================================================

Изначально я предполагал создать два отдельных проекта:
* VMDL - программа, преобразующая модели из различных форматов в мой собственный формат, который я назвал VMDL.
* View3D - программа для просмотра моделей формата VMDL, использующая библиотеку OpenGL.

Впоследствии мне стало не хватать времени на полноценную проработку двух проектов. В проекте VMDL была реализована только загрузка моделей из игры Quake, но не было реализовано сохранение в файл формата VMDL. Проект View3D к этому времени представлял собой тестовое приложение, рисующее куб при помощи библиотеки OpenGL. Чтобы сэкономить время, оба проекта были объединены в один - View3D. Я по-быстрому скомпоновал разработки из двух проектов в одну программу, которая получилась несколько странной, т.к. могла показывать только модели из игры Quake, но перед отрисовкой преобразовывала эти модели в своё внутреннее представление.

Ниже приведены этапы разработки, черновики структур данных и мысли, которые удалось восстановить из нескольких различных текстовых файлов.

История разработки проектов View3D и VMDL
-----------------------------------------

### 13 марта 2003: проект View3D

Тест OpenGL в консольном режиме. Программа носит тестовый характер, в дальнейшем педполагается сделать программу для просмотра моделей из разных игр.

### 14 марта 2003: проект VMDL

Проект моего формата трёхмерных моделей, VMDL:

    //Заголовок, описывает наиболее общую информацию.
    struct mdl_t
    {
            char ident[4];          //Идентификатор формата "VMDL".
            unsigned version;       //Номер версии формата 0.
                                    //Названия и типы дальнейших полей для других
                                    //версий могут быть другими.
            unsigned num_meshes;    //Количество "петель".
            unsigned num_frames;    //Количество кадров, т.е. фаз движения модели.
            unsigned num_vertices;  //Количество вершин в каждом кадре.
    };
    
    //"Петля" является базовым понятием для моего формата модели. Петлёй называется
    //набор треугольников, каждый из которых имеет с другим треугольником из этой же
    //петли по крайней мере одно общее ребро; набор треугольников использующих одну
    //общую текстуру, выбор которой может (и должен) не зависеть от выбора текстур в
    //других петлях.
    const unsigned MAX_NAME =16;
    struct mesh_t
    {
            char mesh_name[MAX_NAME];       //Имя петли, нужно для указания
                                            //прорисовщику имени текстуры для данной
                                            //петли.
            unsigned num_skins;             //Количество текстур для данной петли.
            skin_t skins[num_skins];        //Здесь перечисляются имена текстур,
                                            //любая из которых может быть выбрана без
                                            //каких-либо ограничений.
            unsigned num_points;            //Количество точек на текстуре.
            point_t points[num_points];
                                            //Точки на текстуре.
            unsigned num_triangles;         //Количество треугольников.
            triangle_t triangles[num_triangles];
                                            //Треугольники.
    };
    
    //"Кадр" является вторым базовым понятием моего формата моделей. Кадр - это
    //полный набор пространственных вершин модели и нормалей к каждой вершине,
    //который можно выбрать из имеющихся кадров независимо от чего-либо. Кадр
    //позволяет полностью отобразить конкретное пространственное положение
    //треугольников модели.
    struct frame_t
    {
            char frame_name[MAX_NAME];      //Имя кадра, для указания прорисовщику.
            vec3_t min;                     //Габаритный контейнер, минимальные
            vec3_t max;                     //и максимальные значения координат вершин.
            vec3_t vertices[num_vertices];  //Вершины.
            vec3_t normals[num_vertices];   //Нормали к вершинам.
    };
    struct triangle_t
    {
            unsigned st_indexes[3]; //Треугольник состоит из индексов трёх точек на
                                    //текстуре.
    };
    struct point_t                  //Точка на текстуре.
    {                                       
            float s;                //Координаты s и t, кажая в диапазоне от 0 до 1.
            float t;
            unsigned xyz_index;     //Индекс вершины.
    };
    struct vec3_t   //Трёхмерный вектор - вершина или нормаль.
    {
            float x;//Составляющие вектора.
            float y;
            float z;
    };
    //В качестве формата для хранения текстур предполагается использовать формат
    //TARGA. Текстуры должны располагаться в одном каталоге с моделью.

Появилась реальное желание сделать просмотрщик трёхмерных моделей, для начала Quake.

### 16 марта 2003: проект VMDL

Сделаны процедуры конвертации текстур (кож модели), конвертации точек и треугольников. Не думал, что это окажется настолько просто.

### 17 марта 2003: проект VMDL

Сделана процедура перевода кадров из формата Quake в мой формат, пока что без нормалей.

Добавлена таблица нормалей Quake к вершинам модели. Осталось заполнять таблицу нормалей для каждого кадра.

### 18 марта 2003: проект VMDL

Доделана процедура перевода кадров из формата Quake в мой формат.

Думаю сделать точный расчёт нормалей, поиск габаритов кадров, проверку модели на наличие неверных индексов вершин и точек.

### 21 марта 2003: проект VMDL

Конвертер моделей Quake в мой формат выполнен. Добавлена возможность точного расчёта нормалей вершин, поиск габаритных контейнеров для каждого кадра, проверка индексов точек и вершин.

Выводы:
* В процессе работы было принято решение усложнять мой формат моделей по мере необходимости, а не пытаться сразу сделать универсальный формат. Разработанный до этого формат моделей не применялся.
* Для ускорения сроков выполнения проекта было принято решение слить конвертер моделей и их просмотрщик в одну программу. Это позволит не тратить время на написание процедур сохранения и загрузки моделей, сделать просмотр моделей более удобным с точки зрения пользователя.
* Поскольку OpenGL использует размеры текстур кратные степеням двойки, придётся увеличивать размеры текстур. Текстуры предполагается не растягивать или сжимать, а просто дополнять до нужного размера.
* Файловый формат моделей планируется разработать, когда просмотрщик будет поддерживать все известные мне форматы моделей из разных игр, не применяющих скелетную анимацию. Для скелетно анимированных моделей предполагается разработать собственный файловый формат.

### 21 марта 2003: объединённый проект View3D

Продолжение проекта View3D, в него теперь влился проект VMDL.

Сделан рендеринг моделей, пока без текстур и с глючным закрашиванием методом Фонга.

### 22 марта 2003: объединённый проект View3D

Исправил ошибку с закраской методом Фонга. Нормаль нужно указывать перед созданием вершины, а не после!

Пытался сделать морфинг между кадрами. Выглядит это прикольно, особенно если кадры между собой не связаны. Например - кадр трупа демона и демона в атаке, морфинг даёт демона, сплющенного под углом примерно в 45 градусов к горизонту. От морфинга в моей программе отказался.

### 23 марта 2003: объединённый проект View3D

Пытался сделать текстурирование. Вроде сделано всё правильно, но почему-то не работает. Даже OpenGL не сообщает через glGetError ни о каких ошибках. Ошибка видимо сделана по недосмотру (не заданы некоторые режимы для OpenGL) или ошибка где-то в моей части программы.

### 25 марта 2003: объединённый проект View3D

Текстурирование долго сопротивлялось и не хотело работать. Кое-как удалось заставить его работать с помощю функции gluBuild2DMipmaps. Текстурирование с помощью процедуры glTexImage по-прежнему не работает.

### 26 марта 2003: объединённый проект View3D

Ура! Дело оказалось в настройке фильтров текстуры: текстурирование с режимами фильтров по умолчанию не хочет работать без пирамидных уровней текстур.

Полностью переделал процедуру загрузки модели.

Добавил функцию перелистывания текстур модели.

Обнаружил глюки: модель flame просматривается с искажениями, модель flame2 не грузится.

Программа приближается к релизу. Хотя до него ещё далековато, но принципиальные трудности уже позади, остальная часть - дело техники.

### 27 марта 2003: объединённый проект View3D

Баги пофиксены (...э, в смысле, ошибки исправлены): flame и flame2 теперь просматриваются нормально. Всё из-за того, что в этих моделях применяются форматы групповых кадров. В моей программе групповые кадры читались неверно - я пропускал чтение габаритов группового кадра.

### 31 марта 2003: объединённый проект View3D

Промежуточный релиз. До полного релиза по-прежнему далековато. Всё более-менее приведено в порядок и приобрело товарный вид. Пока что непредвиденных глюков не обнаружено.

### 05 апреля 2003: объединённый проект View3D

На диске Quake Tools я обнаружил модели версии №3, в то время как моя программа подеерживает только версию №6. После небольших исследований была сделана программа для просмотра моделей этой версии.

На диске есть рабочие программы для просмотра моделей именно этой версии.  Поскольку до сих пор я подсовывал этим программам модели 6-й версии, программы завершались с ошибкой времени выполнения (run-time error).  Если бы программеры были поосторожней, они бы обязательно проверяли номер версии модели и выдавали бы вразумительное сообщение. Поскольку никаких вразумительных сообщений нет, можно подумать что либо программа повреждена, либо программер был дурак. Первое маловероятно, так как программа хранилась в архиве, а архиваторы всегда проверяют контрольный код при распаковке. Таким образом теряется авторитет программиста, отсюда вывод:

    ПРОГРАММИСТ, НЕ ЛЕНИСЬ ПРОВОДИТЬ ХОТЯ-БЫ САМУЮ ПРОСТУЮ ПРОВЕРКУ И ДИАГНОСТИКУ.

Я же стараюсь проводить по возможности наиболее полную проверку ошибок с обязательными диагностическими сообщениями. Так легче отлаживать программу, эксплуатировать её и сохранять свой авторитет в глазах пользователей, пусть даже программа не самая сложная. Неприятные эффекты - сложность написания программы, разбухание кода, замедление работы программы. Для устранения замедления программы приходится тщательно выбирать способ и место для проверки ошибки - где это возможно, объединять несколько сложных проверок в одну простую, выводить проверки за пределы циклов и т.п.

### 06 апреля 2003: объединённый проект View3D

Появилась мысль: нужно разделить програму на конвертер и просмотрщик. Нужно разработать файловый формат моделей. Для экономии места предполагается не сохранять то, что можно вычислить. Если не требуется особой точности в представлении данных, можно сделать специализированный формат. Все форматы моделей очень похожи, так как имеют общие корни - Quake и Quake 2. Кандидат в основу моего формата - формат моделей Quake 2, с некоторыми моими изменениями. Изменения в основном каснутся форм представления текстурных вершин и треугольников (как в DOOM III).

### 8 апреля 2003: объединённый проект View3D

Собрал в один каталог все наработки, созданные в процессе разработки программмы. В отдельных каталогах оказались следующие версии программ:
* 0.10 - тест OpenGL в консольном режиме.
* 0.80 - загрузчик MDL моделей 6-й версии Quake.
* 1.00-v6 - промежуточный релиз, просмотр MDL моделей 6-й версии Quake с использованием OpenGL в консольном режиме.
* 1.00-v3 - вариант предыдущей программы для просмотра MDL моделей 3-й версии Quake.
* 1.00-v6-image - экспериментальная версия. Попытка сделать для текстур отдельный класс.
* 1.10-v3&v6 - комбинированная из 1.00-v6 и 1.00-v3 программа, умеет просматривать обе версии моделей.

### 26 апреля 2003: объединённый проект View3D

Разработал формат для хранения моделей MDL из Quake и моделей MD2 из Quake 2. Версия 0:

    const unsigned MAX_MODEL_NAME   =16;
    
    struct file_header
    {
            unsigned ident;         //V3DM  //View3d Model
            unsigned version;       //0
    };
    
    struct model_header
    {
            unsigned palette_index; //0 - Quake, 1 - Quake 2, 2 - палитра следует за этим полем.
            unsigned num_skins;
            unsigned skin_width;
            unsigned skin_height;
            unsigned num_points;
            unsigned num_triangles;
            unsigned num_frames;
            unsigned num_vertices;
            unsigned num_animations;
    };
    
    //RGB skins_palette[256];       //Толко в случае palette_index==2.
    
    struct skin
    {
            char name[MAX_MODEL_NAME];
            unsigned char [skin_height][skin_width];
    } skins[num_skins];
    
    struct point
    {
            short s,t;
            short vertex_index;
    } points[num_points];
    
    struct triangle
    {
            short point_indexes[3];
    } triangles[num_triangles];
    
    struct frame
    {
            char name[MAX_MODEL_NAME];
            float xTranslate,yTranslate,zTranslate;
            float xScale,yScale,zScale;
            struct vertex
            {
                    unsigned char x,y,z,light_normal_index;
            } vertices[num_vertices];
    } frames[num_frames];
    
    struct animation
    {
            char name[MAX_MODEL_NAME];
            unsigned short start_frame;
            unsigned short num_frames;
            float times[num_frames];
    } animations[num_animatons];

С форматом связаны три таблицы: таблица нормалей, палитра Quake и палитра Quake 2.

### 18 июня 2003: объединённый проект View3D

Передавая программу вместе с исходными текстами своим одногрупникам и бывшим одноклассникам, сопроводил её следующим описанием:

    Немного о проекте View3D.
    
    Проект начинался с целью изучения графической библиотеки OpenGL, изучения
    форматов моделей разных игр, изучения способов расчёта элементов моделей,
    преобразования моделей в разные форматы. Сначала предполагалось написать две
    программы: одну для преобразования разных моделей в мой формат, другую для
    просмотра моделей из моего формата.
    
    Когда я почти доделал конвертер моделей Quake (осталось описать функцию
    сохранения в мой формат) времени стало нехватать, началась курсовая по деталям
    машин. Бросать всё недоделанным не хотелось, поэтому я объединил две программы в
    одну и срочно дописал всё это. Получилась заковыристая и неоптимальная
    программа, которая достигает цели (рисование модели) обходными путями, то есть
    сначала конвертирует модель в свой формат (как бы ради развлечения делая
    дополнительные расчёты и преобразования) и только потом рисует модель.
    
    Несколько замечаний насчёт стиля написания программы. Среда Visual C++ 6.0
    изначально не поддерживает кодировку DOS, в которой работают консольные
    Win32-приложения. Мне лень редактировать программу в другом редакторе, поэтому я
    пишу диагностические сообщения по-английски (прошу прощения за то, ЧТО я назвал
    английским). Привычка писать диагностические сообщения на английском языке
    повлияла и на комментарии, которые я тоже иногда пишу по-английски (в основном
    эти комментарии поясняют структуру прграммы, но не объясняют её тонкостей). Так
    что, просьба: громко не ругаться!
    
    Сейчас я снова начал работу в этом направлении, я пишу новую программу, которая
    будет просматривать модели Quake 2.


Лицензия
--------

Программа была написана в 2003 году. В 2018 портирована с 32-битной Windows на 64-битный Linux, с библиотеки GLAUX на библиотеку SDL2.

(C) 2003-2018 Владимир Ступин

Программа распространяется под лицензией GPL 3.
